@model View.Models.ProductAddViewModel

@{
    ViewData["Title"] = "SetProduct";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h1>Thêm Sản Phẩm</h1>


<form asp-action="SetProduct" enctype="multipart/form-data">
    <div class="d-flex justify-content-between mb-3">
        <a asp-action="ListProduct" class="btn btn-secondary mr-2">
            <i class="fa fa-chevron-left" aria-hidden="true"></i> Quay lại
        </a>
        <button type="submit" class="btn btn-success">
            <i class="fa fa-plus" aria-hidden="true"></i> Thêm Mới
        </button>
    </div>
    <section id="multiple-column-form">
        <div class="row match-height">
            <div class="col-12">
                <div class="card">
                    <div class="card-content">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 col-12">
                                    <div class="form-group">
                                        <h6>Mã Sản Phẩm</h6>
                                        <input asp-for="MaSanPham" class="form-control" />
                                    </div>
                                </div>
                                <div class="col-md-6 col-12">
                                    <div class="form-group">
                                        <h6>Tên Sản Phẩm</h6>
                                        <input asp-for="TenSanPham" id="productNameInput"  class="form-control" />
                                    </div>
                                </div>
                                <div class="col-md-6 col-12">
                                    <div class="form-group">
                                        <h6>Giá</h6>
                                        <div class="input-group">
                                            <input asp-for="GiaSanPham" id="giaSanPham" class="form-control" placeholder="Nhập giá sản phẩm" value="" onfocus="removeFormatting()" onblur="formatNumber()" oninput="addCommas()" />
                                            <div class="input-group-append">
                                                <span class="input-group-text">VNĐ</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 col-12">
                                    <div class="form-group">
                                        <h6>Năm Sản Xuất</h6>
                                        <input asp-for="NamSanXuat" class="form-control" value="@DateTime.Now.Year" />
                                    </div>
                                </div>
                                <div class="col-md-6 col-12">
                                    <div class="form-group">
                                        <h6>Thương Hiệu</h6>
                                        <select asp-for="IdBrand" asp-items="ViewBag.Brands" class="form-control select2" style="width: 100%;">
                                            <option value="">Chọn thương hiệu</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6 col-12">
                                    <div class="form-group">
                                        <h6>Nơi Sản Xuất</h6>
                                        <select asp-for="IdNhaSanXuat" asp-items="ViewBag.Manufacturers" class="form-control select2" style="width: 100%;">
                                            <option value="">Chọn nơi sản xuất</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6 col-12">
                                    <div class="form-group">
                                        <h6>Vật Liệu</h6>
                                        <select asp-for="IdVatLieu" asp-items="ViewBag.Materials" class="form-control select2" style="width: 100%;">
                                            <option value="">Chọn vật liệu</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6 col-12">
                                    <div class="form-group">
                                        <h6>Loại Sản Phẩm</h6>
                                        <select asp-for="IdLoaiSanPham" asp-items="ViewBag.ProductTypes" class="form-control select2" style="width: 100%;">
                                            <option value="">Chọn loại sản phẩm</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="form-group">
                                        <h6>Mô Tả</h6>
                                        <textarea asp-for="MoTa" id="MoTa" class="form-control" rows="4" placeholder="Nhập mô tả sản phẩm"></textarea>
                                    </div>
                                </div>
                                <div class="col-md-6 col-12">
                                    <h6>Màu</h6>
                                    <div class="form-group">
                                        <select class="choices form-select multiple-remove" name="SelectedColors" id="colorSelect" multiple="multiple" data-placeholder="Chọn Màu" style="width: 100%;">
                                            @foreach (var color in ViewBag.Colors as List<ColorViewModel>)
                                            {
                                                <option value="@color.Id">@color.Ten</option>
                                            }
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6 col-12">
                                    <h6>Size</h6>
                                    <div class="form-group">
                                        <select class="choices form-select multiple-remove" name="SelectedSizes" id="sizeSelect" multiple="multiple" data-placeholder="Chọn Size" style="width: 100%;">
                                            @foreach (var size in ViewBag.Sizes as List<SizeViewModel>)
                                            {
                                                <option value="@size.Id">@size.Ten</option>
                                            }
                                        </select>
                                    </div>
                                </div>

                                <div class="col-12">
                                    <h5>Chi tiết sản phẩm</h5>
                                    <div class="row" id="table-borderless">
                                    </div>
                                </div>
                                <input type="file" id="fileInput" multiple accept="image/*" style="display: none;" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>
    </section>
</form>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        // Hàm thêm dấu phẩy vào số
        function addCommas() {
            var input = document.getElementById('giaSanPham');
            var value = input.value.replace(/\./g, ''); // Bỏ dấu chấm
            value = value.replace(/,/g, ''); // Bỏ dấu phẩy
            if (!isNaN(value) && value !== '') {
                // Thêm dấu phẩy vào số
                input.value = parseInt(value).toLocaleString('vi-VN');
            }
        }

        // Hàm bỏ định dạng khi focus vào ô input
        function removeFormatting() {
            var input = document.getElementById('giaSanPham');
            // Bỏ dấu phẩy và chuyển về giá trị số
            input.value = input.value.replace(/\./g, '').replace(/,/g, '');
        }

        // Tự động định dạng số khi load trang nếu có giá trị
        window.onload = function () {
            var input = document.getElementById('giaSanPham');
            // Định dạng số nếu có giá trị
            if (input.value) {
                addCommas();
            }
        };


        // Hiển thị bảng chi tiết sản phẩm dựa trên màu đã chọn
        // Định nghĩa hàm removeRow ở bên ngoài
        function removeRow(button) {
            const row = button.closest('tr'); // Lấy hàng cha của nút "Xóa"
            if (row) {
                row.remove(); // Xóa hàng khỏi bảng
            }
        }

        document.addEventListener("DOMContentLoaded", function () {
            const colorSelect = document.getElementById('colorSelect');
            const sizeSelect = document.getElementById('sizeSelect');
            const tableContainer = document.getElementById('table-borderless');
            const productNameInput = document.getElementById('productNameInput');
            const fileInput = document.getElementById('fileInput');
            const selectedImages = {}; // Đối tượng lưu trữ ảnh theo màu

            const renderTable = () => {
                const selectedColors = Array.from(colorSelect.selectedOptions).map(option => option.text);
                const selectedSizes = Array.from(sizeSelect.selectedOptions).map(option => option.text);
                const productName = productNameInput.value;
                tableContainer.innerHTML = ''; // Xóa bảng cũ khi thay đổi lựa chọn

                selectedColors.forEach(color => {
                    const imagesHtml = (selectedImages[color] || []).map(file => {
                        const imgSrc = URL.createObjectURL(file);
                        return `<img src="${imgSrc}" alt="${file.name}" style="width: 50px; height: 50px; margin: 5px;" />`;
                    }).join('');

                    const cardHtml = `
                        <div class="col-12 mb-3">
                            <div class="card">
                                <div class="card-header">
                                    <h4 class="card-title">Màu: ${color}</h4>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-borderless mb-0">
                                        <thead>
                                            <tr>
                                                <th>Sản Phẩm</th>
                                                <th>Kích Thước</th>
                                                <th>Số Lượng</th>
                                                <th></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${selectedSizes.map(size => `
                                                <tr>
                                                    <td>${productName}</td>
                                                    <td>${size}</td>
                                                    <td><input type="text" class="form-control round" value="10"></td>
                                                    <td><button type="button" class="btn btn-danger rounded-pill" onclick="removeRow(this)">Xóa</button></td>
                                                </tr>
                                            `).join('')}
                                            <tr>
                                                <td colspan="3" class="text-end">
                                                    <span class="btn btn-info rounded-pill" onclick="document.getElementById('fileInput').setAttribute('data-current-color', '${color}'); document.getElementById('fileInput').click();">Thêm ảnh</span>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td colspan="5">
                                                    <div id="image-container-${color}" class="image-container">${imagesHtml}</div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                    tableContainer.insertAdjacentHTML('beforeend', cardHtml);
                });
            };

            // Xử lý sự kiện khi người dùng chọn ảnh
            fileInput.addEventListener('change', function () {
                const color = fileInput.getAttribute('data-current-color'); // Lấy màu hiện tại
                if (!color) return; // Nếu không có màu, thoát hàm

                const files = Array.from(fileInput.files);
                if (!selectedImages[color]) {
                    selectedImages[color] = []; // Khởi tạo mảng ảnh cho màu mới
                }

                if (selectedImages[color].length + files.length > 3) {
                    alert("Bạn chỉ được chọn tối đa 3 ảnh cho mỗi màu.");
                    return;
                }

                selectedImages[color] = selectedImages[color].concat(files); // Thêm ảnh mới vào danh sách đã chọn cho màu hiện tại
                renderTable(); // Cập nhật bảng
            });

            // Đăng ký sự kiện cho sự thay đổi lựa chọn màu sắc và kích thước
            if (colorSelect) {
                colorSelect.addEventListener('change', renderTable);
            }

            if (sizeSelect) {
                sizeSelect.addEventListener('change', renderTable);
            }
            productNameInput.addEventListener('input', renderTable);
        });


    </script>
}
